<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>Firmware Cliente - SO2 TP1: main.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Firmware Cliente - SO2 TP1
   &#160;<span id="projectnumber">v1.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">main.c</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="preprocessor">#include &lt;stdio.h&gt;</span></div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="preprocessor">#include &lt;string.h&gt;</span></div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="preprocessor">#include &lt;sys/socket.h&gt;</span></div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="preprocessor">#include &lt;netinet/in.h&gt;</span> <span class="comment">// la estructura sockaadr_in pertence a esta libreria</span></div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="preprocessor">#include &lt;arpa/inet.h&gt;</span></div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="preprocessor">#include &lt;unistd.h&gt;</span> <span class="comment">//en esta libreria esta la funcion sleep(), la funcion read()</span></div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="preprocessor">#include &lt;sys/sysinfo.h&gt;</span></div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="preprocessor">#include &lt;stdbool.h&gt;</span></div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="preprocessor">#include &lt;fcntl.h&gt;</span></div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="preprocessor">#include &lt;stdlib.h&gt;</span></div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="preprocessor">#include &lt;sys/stat.h&gt;</span></div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="preprocessor">#define BUFFER_SIZE 1000</span></div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="preprocessor">#define PORTUDP 5521</span></div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="preprocessor">#define FIRMWARE_FILE &quot;./update_file&quot;</span></div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="preprocessor">#define FILE_BUFFER_SIZE 4000</span></div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="preprocessor">#define ARCHIVO_IMAGEN &quot;./archivo_imagen_cli.JPG&quot;</span></div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="keywordtype">char</span> firmware_version[20] = <span class="stringliteral">&quot;1.0&quot;</span>;</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;uint16_t server_port= 5520;</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="keywordtype">char</span> ip_server_buff[32]=<span class="stringliteral">&quot;192.168.1.4&quot;</span>;</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="keywordtype">char</span> *ip_server = NULL;</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> retry_time=3;</div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="comment">//char buffer[BUFFER_SIZE], auxBuffer[BUFFER_SIZE];</span></div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;</div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;</div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="keywordtype">long</span> get_uptime(); <span class="comment">//esta funcion devuelve el uptime del SO del satelite</span></div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="comment">//funcion 1</span></div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="keywordtype">int</span> update_firmware(<span class="keywordtype">int</span> sockfd_arg);</div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="comment">//funcion 2</span></div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="keywordtype">int</span> start_scanning(<span class="keywordtype">int</span> sockfd);</div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="keywordtype">int</span> send_telemetria();</div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;</div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;</div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;</div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="keywordtype">int</span> main() {</div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;</div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;    printf(<span class="stringliteral">&quot;DEBUG: ejecutando main \n&quot;</span>);</div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;    printf(<span class="stringliteral">&quot;Version del firmware: %s\n&quot;</span>, firmware_version);</div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;    <span class="keywordtype">int</span> sockfd, ip_srv_load;</div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;    <span class="keyword">struct </span>sockaddr_in dest_addr;</div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;</div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;    <span class="keywordtype">char</span> buffer_recepcion[BUFFER_SIZE];</div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;</div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;    <span class="comment">//crer socket</span></div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;    sockfd= socket(AF_INET, SOCK_STREAM, 0);</div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;    <span class="keywordflow">if</span> (sockfd &lt;0){</div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;        perror(<span class="stringliteral">&quot;error al abrir el socket cliente&quot;</span>);</div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;    }</div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;</div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;    <span class="comment">//setear la estructura sockaddr</span></div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;    memset(&amp;dest_addr, 0, <span class="keyword">sizeof</span>(dest_addr) ); <span class="comment">//limpieza de la estructura</span></div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;    dest_addr.sin_family= AF_INET;</div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;    dest_addr.sin_port=htons(server_port);</div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;    ip_server = (<span class="keywordtype">char</span> *)&amp;ip_server_buff;</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;    <span class="comment">//https://www.systutorials.com/docs/linux/man/3-inet_aton/</span></div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;    <span class="comment">//The inet_aton() function returns 1 if the address is successfully converted, or 0 if the conversion failed.</span></div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;    <span class="keywordflow">if</span> (  inet_aton(ip_server, &amp;dest_addr.sin_addr ) == 0 )  {</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;        fprintf(stderr, <span class="stringliteral">&quot;Invalid address\n&quot;</span>);</div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;</div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;    }</div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;    <span class="comment">//Conexion</span></div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;    <span class="comment">//Upon successful completion, connect() returns 0. Otherwise, -1 is returned and errno is set to indicate the error.</span></div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;    <span class="keywordflow">while</span>( connect( sockfd, (<span class="keyword">struct</span> sockaddr *)&amp;dest_addr, <span class="keyword">sizeof</span>(dest_addr) ) &lt; 0 ){</div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;        perror(<span class="stringliteral">&quot;Intentando conectar al servidor&quot;</span>);</div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;        <span class="comment">//printf(&quot;Reintentando coenctar en %d segundos \n&quot;, retry_time);</span></div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;        sleep(retry_time);</div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;    }</div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;    printf(<span class="stringliteral">&quot;Se ha realizado la conexion de manera exitosa con el servidor \n&quot;</span>);</div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;</div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;</div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;    <span class="keywordflow">while</span>( strcmp(buffer_recepcion, <span class="stringliteral">&quot;fin\n&quot;</span>) != 0  ){</div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;        memset(buffer_recepcion, 0 , <span class="keyword">sizeof</span>(buffer_recepcion));</div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;</div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;        <span class="comment">//En este punto se recibe el comando desde la estacion terresre en forma de codigo numerico</span></div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;        <span class="comment">//Upon successful completion, recv() returns the length of the message in bytes. If no messages are available to be received and the peer has performed an orderly shutdown, recv() returns 0. Otherwise, -1 is returned and errno is set to indicate the error.</span></div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;        <span class="keywordflow">if</span> (recv(sockfd, buffer_recepcion, <span class="keyword">sizeof</span>(buffer_recepcion), 0  ) &lt; 0){</div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;            perror(<span class="stringliteral">&quot;error al recibir&quot;</span>);</div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;        }</div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;        <span class="comment">//opciones del lado del cliente:</span></div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;        <span class="comment">/*</span></div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;<span class="comment">        1 - Update Satellite Firmware</span></div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;<span class="comment">        2 - Start Scanning</span></div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;<span class="comment">        3 - Get Telemetry</span></div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;<span class="comment">        */</span></div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;        printf(<span class="stringliteral">&quot;%s\n&quot;</span>, buffer_recepcion);</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;        <span class="keywordflow">if</span> (strcmp(buffer_recepcion, <span class="stringliteral">&quot;1&quot;</span>) == 0 ){ <span class="comment">// Update Satellite Firmware</span></div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;            memset(buffer_recepcion, 0, <span class="keyword">sizeof</span>(buffer_recepcion));</div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;</div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;            <span class="comment">//recv(sockfd, buffer_recepcion, sizeof(buffer_recepcion), 0 );</span></div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;</div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;            update_firmware(sockfd); <span class="comment">// le paso a la func el sockfd que debe usar ya que ahi llegaran los datos</span></div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;</div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;        }</div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp(buffer_recepcion, <span class="stringliteral">&quot;2&quot;</span>) == 0 ){ <span class="comment">// Start Scanning</span></div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;            start_scanning(sockfd);</div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;        }</div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strcmp(buffer_recepcion, <span class="stringliteral">&quot;3&quot;</span>) == 0 ){ <span class="comment">// Get Telemetry</span></div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;            send_telemetria();</div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;        }</div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;        <span class="keywordflow">else</span>{</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;            printf(<span class="stringliteral">&quot;DEBUG: se recibio algo distinto de 1 2 o 3\n&quot;</span>);</div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;            sleep(2);</div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;        }</div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;</div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;</div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;    }<span class="comment">//end while</span></div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;</div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;    <span class="keywordflow">if</span> ( shutdown( sockfd, SHUT_RDWR ) &lt; 0 ){</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;        perror(<span class="stringliteral">&quot;shutdown fail&quot;</span>);</div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;    }</div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;</div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;    <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;}<span class="comment">//end main</span></div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;</div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;<span class="keywordtype">long</span> get_uptime(){</div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;    <span class="keyword">struct </span>sysinfo s_info;</div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;    <span class="keywordtype">int</span> error = sysinfo(&amp;s_info);</div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;    <span class="keywordflow">if</span>(error != 0)</div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;    {</div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;        printf(<span class="stringliteral">&quot;code error = %d\n&quot;</span>, error);</div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;    }</div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;    <span class="keywordflow">return</span> s_info.uptime;</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;}</div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;</div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;<span class="comment">//funcion 1</span></div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;<span class="comment"></span><span class="keywordtype">int</span> update_firmware(<span class="keywordtype">int</span> sockfd_arg){</div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;    printf(<span class="stringliteral">&quot;DEBUG: ha invocado la funcion &#39;Update Satellite Firmware&#39;\n&quot;</span>);</div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;    printf(<span class="stringliteral">&quot;la version actual del firmware en este dispositivo es: %s\n&quot;</span>, firmware_version);</div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;    <span class="keywordtype">int</span> firmware_fd;</div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;    <span class="keywordtype">int</span> bytes_escritos=0;</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;    <span class="comment">//try to open fd</span></div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;<span class="comment">    //https://pubs.opengroup.org/onlinepubs/009695399/functions/open.html</span></div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;<span class="comment">    //int open(const char *path, int oflag, file_permissions );</span></div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;<span class="comment">    */</span></div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;    <span class="keywordflow">if</span> ( (firmware_fd=open(FIRMWARE_FILE, O_WRONLY|O_CREAT|O_TRUNC, 0777) ) &lt; 0 ){</div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;        perror(<span class="stringliteral">&quot;error al crear el archivo&quot;</span>);</div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;        <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;    }</div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;</div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;    <span class="keywordtype">char</span> buffer_recepcion[FILE_BUFFER_SIZE]; <span class="comment">//FILE_BUFFER_SIZE=16000</span></div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;    <span class="keywordtype">long</span> byte_leido;</div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;</div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;    uint32_t bytes_recibidos;</div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;    <span class="comment">//atencion que estoy leyendo de a 4 bytes a la vez, no leo el stream completo</span></div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;    <span class="keywordflow">if</span> ( (byte_leido=recv(sockfd_arg, &amp;bytes_recibidos, 4, 0) ) != 0 ){</div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;        <span class="keywordflow">if</span> ( byte_leido &lt;= 0 ){</div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;            perror(<span class="stringliteral">&quot;error en la recepcion a traves del socket_arg&quot;</span>);</div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;        }</div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;</div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;    }</div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;</div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;    <span class="comment">//se transforma el numero de bytes recibidos de network a host long (uint32_t)</span></div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;    bytes_recibidos=ntohl(bytes_recibidos);</div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;    printf(<span class="stringliteral">&quot;Cantidad de bytes en el archivo a recibir (stream TCP): %i\n&quot;</span>, bytes_recibidos);</div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;</div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;</div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;    <span class="comment">//mientras queden bytes sin leer...</span></div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;    <span class="keywordflow">while</span>(bytes_recibidos){</div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;        memset(buffer_recepcion, 0, <span class="keyword">sizeof</span>(buffer_recepcion));</div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;</div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;        <span class="comment">//controlo un prosible error de recepcion</span></div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;        <span class="keywordflow">if</span>( (byte_leido = recv(sockfd_arg, buffer_recepcion, <span class="keyword">sizeof</span>(buffer_recepcion), 0)) != 0){</div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;            <span class="keywordflow">if</span> (byte_leido &lt; 0){</div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;                perror(<span class="stringliteral">&quot;error en la recepcion en el socket &#39;sockfd_arg&#39;&quot;</span>);</div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;            }</div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;        }</div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;</div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;        <span class="comment">//voy a ir escribiendo el archivo que cree oon los bytes que vaya &quot;sacando/leyendo&quot; del socket</span></div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;        <span class="keywordflow">if</span>(0 &gt; (bytes_escritos = write(firmware_fd, buffer_recepcion, (<span class="keywordtype">size_t</span>) byte_leido))  ){</div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;                perror(<span class="stringliteral">&quot;error al escribir el archivo creado&quot;</span>);</div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;                _exit(EXIT_FAILURE);</div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;        }</div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;</div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;        printf(<span class="stringliteral">&quot;%d\n&quot;</span>, bytes_escritos);</div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;        bytes_recibidos -= byte_leido;</div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;    }</div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;</div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;    <span class="comment">//cierro el file descriptor</span></div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;    close(firmware_fd);</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;</div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;    printf(<span class="stringliteral">&quot;DEBUG: Finalizada la recepcion del archivo desde la estacion terrestre\n&quot;</span>);</div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;    printf(<span class="stringliteral">&quot;reiniciando el sistema con el nuevo firmware\n&quot;</span>);</div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;    <span class="comment">//cierro tambien el socket_arg</span></div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;    close(sockfd_arg); <span class="comment">//esto lo cierro solocuando implemente el RE-EJECUTAR</span></div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;</div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;    <span class="comment">//aca esta faltando la parte de reiniciar automaticamente el programa con la nueva version de firmware</span></div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;    <span class="keywordtype">char</span> ejecutable[100] = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;    strcat(ejecutable, FIRMWARE_FILE );</div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;    <span class="keywordtype">char</span> *argv[] = {FIRMWARE_FILE, NULL};</div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;    <span class="comment">//ejemplode uso de excev</span></div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;<span class="comment">     https://pubs.opengroup.org/onlinepubs/009695399/functions/exec.html</span></div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;<span class="comment">     Using execv()</span></div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;<span class="comment"></span></div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;<span class="comment">        The following example passes arguments to the ls command in the cmd array.</span></div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;<span class="comment"></span></div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;<span class="comment">        #include &lt;unistd.h&gt;</span></div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;<span class="comment"></span></div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;<span class="comment"></span></div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;<span class="comment">        int ret;</span></div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;<span class="comment">        char *cmd[] = { &quot;ls&quot;, &quot;-l&quot;, (char *)0 };</span></div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;<span class="comment">        ...</span></div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;<span class="comment">        ret = execv (&quot;/bin/ls&quot;, cmd);</span></div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;<span class="comment">    */</span></div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;    <span class="keywordflow">if</span> (execv(ejecutable, argv) &lt; 0){</div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;        perror(<span class="stringliteral">&quot;error al reiniciar&quot;</span>);</div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;    }</div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;    <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;}</div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;</div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;<span class="comment">//funcion 2</span></div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;<span class="comment"></span><span class="keywordtype">int</span> start_scanning(<span class="keywordtype">int</span> sockfd_arg2){</div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;    printf(<span class="stringliteral">&quot;ha invocado la funcion &#39;start_scanning&#39; \n&quot;</span>);</div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;    <span class="keywordtype">int</span> imagen_fd;</div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;    <span class="keyword">struct </span>stat wtf;</div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;    <span class="keywordtype">char</span> *archivo_imagen=ARCHIVO_IMAGEN;</div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;    <span class="keywordflow">if</span> ((imagen_fd=open(archivo_imagen, O_RDONLY)) &lt; 0){</div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;        perror(<span class="stringliteral">&quot;error al abrir el archivo de imagen\n&quot;</span>);</div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;        <span class="keywordflow">return</span> -1; <span class="comment">//esto es cero porque da error. Se le podria cambiar a otro valor como -1</span></div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;    }</div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;</div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;    <span class="keywordtype">int</span> count;</div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;    <span class="keywordtype">char</span> buffer_envio2[FILE_BUFFER_SIZE];</div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;    fstat(imagen_fd, &amp;wtf);</div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;    off_t file_size= wtf.st_size;</div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;    printf(<span class="stringliteral">&quot;DEBUG: tamaño del archivo a enviar %li bytes\n&quot;</span>, file_size);</div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;    u_int32_t bytes=htonl(file_size);</div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;    <span class="keywordtype">char</span> *send_bytes = (<span class="keywordtype">char</span>*)&amp;bytes;</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;    printf(<span class="stringliteral">&quot;DEBUG: n° de bytes a enviar: %i\n&quot;</span>, ntohl(bytes) );</div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;</div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;    <span class="keywordflow">if</span>(send(sockfd_arg2, send_bytes, <span class="keyword">sizeof</span>(bytes), 0 ) &lt;0 ){</div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;        perror(<span class="stringliteral">&quot;error al enviar el archivo de imagen&quot;</span>);</div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;    }</div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;</div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;    <span class="keywordflow">while</span> ( (count = read(imagen_fd, buffer_envio2, FILE_BUFFER_SIZE) ) &gt; 0){</div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;        <span class="keywordflow">if</span>(send(sockfd_arg2, buffer_envio2, count, 0) &lt; 0 ){</div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;            perror(<span class="stringliteral">&quot;error al enviar el archivo de imagen en la suscesion de bytes&quot;</span>);</div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;        }</div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;        memset(buffer_envio2, 0, <span class="keyword">sizeof</span>(buffer_envio2));</div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;    }</div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;    close(imagen_fd);</div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;    printf(<span class="stringliteral">&quot;DEBUG: envio de la imagen finalizado\n&quot;</span>);</div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;    <span class="keywordflow">return</span> 1; <span class="comment">//se retorna 1 al completar con exito el envio de la imagen</span></div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;</div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;}</div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;</div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;<span class="comment">//funcion 3</span></div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;<span class="comment"></span><span class="keywordtype">int</span> send_telemetria(){</div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;    printf(<span class="stringliteral">&quot;DEBUG: se hainvocado la funcion send_telemetria \n&quot;</span>);</div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;</div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;    <span class="comment">//implementacion</span></div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;    <span class="keywordtype">char</span> telemetria[200];</div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;    <span class="keywordtype">int</span> num =0;</div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;    <span class="keywordtype">char</span> *str=<span class="stringliteral">&quot;a&quot;</span>;</div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;    sprintf(telemetria, <span class="stringliteral">&quot;%d|%s| \n&quot;</span>, num, str);</div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;    printf(<span class="stringliteral">&quot;DEBUG: telemetria = %s\n&quot;</span>, telemetria);</div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;</div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;    <span class="comment">//envio por UDP</span></div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;    <span class="keywordtype">int</span> sockudp_client;</div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;    <span class="keyword">struct </span>sockaddr_in st_server; <span class="comment">//aca hay que poner la IP que vaya a tener el satellite, quien oficia de server UDP</span></div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;    sockudp_client = socket(AF_INET, SOCK_DGRAM, 0);</div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;    <span class="keywordflow">if</span> ( sockudp_client &lt; 0){</div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;        perror(<span class="stringliteral">&quot;error al abrir el socket UDP en el cliente&quot;</span>);</div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;        <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;    }</div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;</div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;    <span class="comment">//limpio la estrucutra que contiene los datos del server</span></div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;    memset(&amp;st_server, 0, <span class="keyword">sizeof</span>(st_server));</div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;    <span class="comment">//carga de la estructura</span></div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;    st_server.sin_family=AF_INET;</div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;    <span class="comment">// le estoy cargando la ip del servidor al socket, ojo que no se si esta bien porque juan le mete aca la ip de cualerui internfaz del cliente &quot;ANYADDR&quot;</span></div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;    <span class="comment">//Carga de dirección IPv4 del socket</span></div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;<span class="comment">     aca se le pone directamente la macro INADDR_ANY a la estructura &quot;st_server&quot; porque este sera el socket server UDP</span></div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;<span class="comment">    */</span></div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;    st_server.sin_addr.s_addr=INADDR_ANY;</div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;    st_server.sin_port=htons(PORTUDP);</div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;</div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;    <span class="comment">//seteo de las opciones del socket</span></div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;    <span class="keywordtype">int</span> valor=1;</div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;    setsockopt(sockudp_client, SOL_SOCKET, SO_REUSEADDR, &amp;valor, <span class="keyword">sizeof</span>(valor)); <span class="comment">// le indico al SO que puede reutilizar la dir del socket</span></div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;</div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;    <span class="comment">//se hace el bind porque en esta fucion &quot;send telemetria&quot; quien oficia de server y recibe una peticion a traves de UDP en este caso es el satelite y no la base terrestre</span></div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;    <span class="keywordflow">if</span> ( bind(sockudp_client, (<span class="keyword">struct</span> sockaddr *)&amp;st_server, <span class="keyword">sizeof</span>(st_server) )  &lt; 0 ){</div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;        perror(<span class="stringliteral">&quot;satellite: error al hacer bind en el socket_udp&quot;</span>);</div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;    }</div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;</div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;    socklen_t dest_size= <span class="keyword">sizeof</span>(<span class="keyword">struct </span>sockaddr);</div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;    <span class="keywordtype">char</span> buffer[BUFFER_SIZE];</div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;</div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;</div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;    printf(<span class="stringliteral">&quot;esperando que la base solicite la telemetria \n&quot;</span>);</div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;    <span class="keywordflow">while</span> (strcmp(buffer, <span class="stringliteral">&quot;get_tel&quot;</span>) != 0){</div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;        <span class="comment">// recbir de: estacion terrestre</span></div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;        <span class="comment">//</span></div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;</div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;        <span class="keywordflow">if</span> ( recvfrom(sockudp_client, buffer, <span class="keyword">sizeof</span>(buffer), 0, (<span class="keyword">struct</span> sockaddr *)&amp;st_server, &amp;dest_size  ) &lt;0 ){</div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;            perror(<span class="stringliteral">&quot;error al recibir UDP desde etacion terrestre&quot;</span>);</div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;        }</div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;</div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;    }</div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;</div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;    <span class="comment">//envio de la telemetria</span></div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;    memset(buffer, 0, <span class="keyword">sizeof</span>(buffer));</div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;    strcpy(buffer,telemetria);</div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;    <span class="keywordflow">if</span> ( sendto(sockudp_client, buffer, strlen(telemetria), 0, (<span class="keyword">struct</span> sockaddr *)&amp;st_server, dest_size) &lt;0 ){</div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;        perror(<span class="stringliteral">&quot;error al enviar telemetria por UDP&quot;</span>);</div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;        _exit(1);</div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;    }</div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;    printf(<span class="stringliteral">&quot;DEBUG: telemetria enviada\n&quot;</span>);</div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;    sleep(1); <span class="comment">//le doy tiempo a la estacion para que parsee la telemetria</span></div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;</div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;    <span class="comment">//envio mensaje de finalizacion</span></div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;    <span class="keywordtype">char</span> *finish = <span class="stringliteral">&quot;udp_complete&quot;</span>;</div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;    <span class="keywordflow">if</span> ( sendto(sockudp_client, finish, strlen(finish), 0, (<span class="keyword">struct</span> sockaddr *)&amp;st_server, dest_size  ) &lt;0 ){</div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;        perror(<span class="stringliteral">&quot;error al enviar el finish&quot;</span>);</div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;        _exit(1);</div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;    }</div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;    printf(<span class="stringliteral">&quot;DEBUG: mensaje de finalizacion enviado\n&quot;</span>);</div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;</div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;    <span class="comment">//limpio el buffer</span></div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;    memset(buffer, 0, <span class="keyword">sizeof</span>(buffer));</div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;    printf(<span class="stringliteral">&quot;DEBUG: en este punto la telemetria deberia estar enviada\n&quot;</span>);</div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;</div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;    <span class="comment">//shutdown(sock, opt)</span></div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;    <span class="comment">//https://pubs.opengroup.org/onlinepubs/7908799/xns/shutdown.html</span></div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;    shutdown(sockudp_client, 2); <span class="comment">//opcion 2 = SHUT_WR</span></div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;    close(sockudp_client);</div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;    <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;</div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;}<span class="comment">//fin send_telemetria</span></div></div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
